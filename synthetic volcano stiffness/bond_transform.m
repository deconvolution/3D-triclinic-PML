function M=bond_transform(theta,nx,ny,nz)
N=zeros(3,3,nx,ny,nz);
N(1,1,:,:,:)=cos(theta);
N(1,2,:,:,:)=sin(theta);
N(2,1,:,:,:)=-sin(theta);
N(2,2,:,:,:)=cos(theta);
N(3,3,:,:,:)=1;

M=zeros(6,6,nx,ny,nz);
for i=1:3
    M(i,1,:,:,:)=N(i,1,:,:,:).^2;
    M(i,2,:,:,:)=N(i,2,:,:,:).^2;
    M(i,3,:,:,:)=N(i,3,:,:,:).^2;
    M(i,4,:,:,:)=2*N(i,2,:,:,:).*N(i,3,:,:,:);
    M(i,5,:,:,:)=2*N(i,3,:,:,:).*N(i,1,:,:,:);
    M(i,6,:,:,:)=2*N(i,1,:,:,:).*N(i,2,:,:,:);
end


M(4,1,:,:,:)=N(2,1,:,:,:).*N(3,1,:,:,:);
M(4,2,:,:,:)=N(2,2,:,:,:).*N(3,2,:,:,:);
M(4,3,:,:,:)=N(2,3,:,:,:).*N(3,3,:,:,:);
M(4,4,:,:,:)=N(2,2,:,:,:).*N(3,3,:,:,:)+N(2,3,:,:,:).*N(3,2,:,:,:);
M(4,5,:,:,:)=N(2,1,:,:,:).*N(3,3,:,:,:)+N(2,3,:,:,:).*N(3,1,:,:,:);
M(4,6,:,:,:)=N(2,2,:,:,:).*N(3,1,:,:,:)+N(2,1,:,:,:).*N(3,2,:,:,:);

M(5,1,:,:,:)=N(3,1,:,:,:).*N(1,1,:,:,:);
M(5,2,:,:,:)=N(3,2,:,:,:).*N(1,2,:,:,:);
M(5,3,:,:,:)=N(3,3,:,:,:).*N(1,3,:,:,:);
M(5,4,:,:,:)=N(1,2,:,:,:).*N(3,3,:,:,:)+N(1,3,:,:,:).*N(3,2,:,:,:);
M(5,5,:,:,:)=N(1,3,:,:,:).*N(3,1,:,:,:)+N(1,1,:,:,:).*N(3,3,:,:,:);
M(5,6,:,:,:)=N(1,1,:,:,:).*N(3,2,:,:,:)+N(1,2,:,:,:).*N(3,1,:,:,:);

M(6,1,:,:,:)=N(1,1,:,:,:).*N(2,1,:,:,:);
M(6,2,:,:,:)=N(1,2,:,:,:).*N(2,2,:,:,:);
M(6,3,:,:,:)=N(1,3,:,:,:).*N(2,3,:,:,:);
M(6,4,:,:,:)=N(1,2,:,:,:).*N(2,3,:,:,:)+N(1,3,:,:,:).*N(2,2,:,:,:);
M(6,5,:,:,:)=N(1,3,:,:,:).*N(2,1,:,:,:)+N(1,1,:,:,:).*N(2,3,:,:,:);
M(6,6,:,:,:)=N(1,1,:,:,:).*N(2,2,:,:,:)+N(1,2,:,:,:).*N(2,1,:,:,:);
end